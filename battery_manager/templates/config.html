{% extends "base.html" %}

{% block title %}Konfiguration - Kostal Battery Manager{% endblock %}

{% block content %}
<div class="config-page">
    <h1>âš™ï¸ Konfiguration</h1>
    
    <form id="config-form" onsubmit="saveConfig(event)">
        <!-- Inverter Settings -->
        <div class="card">
            <h2>ğŸ”Œ Wechselrichter</h2>
            <div class="form-group">
                <label for="inverter_ip">IP-Adresse:</label>
                <input type="text" id="inverter_ip" name="inverter_ip" value="{{ config.inverter_ip }}" required>
            </div>
            <div class="form-group">
                <label for="inverter_port">Port:</label>
                <input type="number" id="inverter_port" name="inverter_port" value="{{ config.inverter_port }}" required>
            </div>
            <div class="form-group">
                <label for="installer_password">Installer-Passwort:</label>
                <input type="password" id="installer_password" name="installer_password" value="{{ config.installer_password }}" required>
            </div>
            <div class="form-group">
                <label for="master_password">Master-Passwort:</label>
                <input type="password" id="master_password" name="master_password" value="{{ config.master_password }}" required>
            </div>
        </div>

        <!-- Battery Settings -->
        <div class="card">
            <h2>ğŸ”‹ Batterie</h2>
            <div class="form-group">
                <label for="battery_capacity">KapazitÃ¤t (kWh):</label>
                <input type="number" id="battery_capacity" name="battery_capacity" 
                       value="{{ config.battery_capacity }}" step="0.1" min="1" max="100" required>
            </div>
            <div class="form-group">
                <label for="max_charge_power">Max. Ladeleistung (W):</label>
                <input type="number" id="max_charge_power" name="max_charge_power" 
                       value="{{ config.max_charge_power }}" min="100" max="10000" step="100" required>
            </div>
            <div class="form-group">
                <label for="min_soc">Min. SOC (%):</label>
                <input type="number" id="min_soc" name="min_soc" 
                       value="{{ config.min_soc }}" min="5" max="95" step="5" required>
            </div>
            <div class="form-group">
                <label for="max_soc">Max. SOC (%):</label>
                <input type="number" id="max_soc" name="max_soc" 
                       value="{{ config.max_soc }}" min="10" max="100" step="5" required>
            </div>
        </div>

        <!-- Optimization Settings -->
        <div class="card">
            <h2>ğŸ’° Tibber Optimierung</h2>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enable_tibber_optimization" name="enable_tibber_optimization"
                           {% if config.enable_tibber_optimization %}checked{% endif %}>
                    Automatische Optimierung aktivieren
                </label>
            </div>
            <div class="form-group">
                <label for="price_threshold">Preisschwelle (% des Durchschnitts):</label>
                <input type="number" id="price_threshold" name="price_threshold" 
                       value="{{ config.price_threshold }}" min="0.5" max="1.0" step="0.05" required>
                <small>Laden nur wenn Preis unter diesem Wert liegt</small>
            </div>
        </div>

        <!-- Sensors -->
        <div class="card">
            <h2>ğŸ“Š Home Assistant Sensoren</h2>
            <div class="form-group">
                <label for="battery_soc_sensor">Batterie SOC Sensor:</label>
                <input type="text" id="battery_soc_sensor" name="battery_soc_sensor" 
                       value="{{ config.battery_soc_sensor or 'sensor.zwh8_8500_battery_soc' }}">
            </div>
            <div class="form-group">
                <label for="forecast_sensor_1">PV Forecast Sensor 1:</label>
                <input type="text" id="forecast_sensor_1" name="forecast_sensor_1" 
                       value="{{ config.forecast_sensor_1 or '' }}"
                       placeholder="sensor.energy_production_today">
            </div>
            <div class="form-group">
                <label for="forecast_sensor_2">PV Forecast Sensor 2:</label>
                <input type="text" id="forecast_sensor_2" name="forecast_sensor_2" 
                       value="{{ config.forecast_sensor_2 or '' }}"
                       placeholder="sensor.energy_production_today_2">
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="card">
            <h2>ğŸ”§ Erweitert</h2>
            <div class="form-group">
                <label for="control_interval">Steuerungs-Intervall (Sekunden):</label>
                <input type="number" id="control_interval" name="control_interval" 
                       value="{{ config.control_interval }}" min="10" max="300" step="10" required>
            </div>
            <div class="form-group">
                <label for="log_level">Log Level:</label>
                <select id="log_level" name="log_level">
                    <option value="debug" {% if config.log_level == 'debug' %}selected{% endif %}>Debug</option>
                    <option value="info" {% if config.log_level == 'info' %}selected{% endif %}>Info</option>
                    <option value="warning" {% if config.log_level == 'warning' %}selected{% endif %}>Warning</option>
                    <option value="error" {% if config.log_level == 'error' %}selected{% endif %}>Error</option>
                </select>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ğŸ’¾ Speichern</button>
            <button type="button" onclick="location.reload()" class="btn btn-secondary">ğŸ”„ ZurÃ¼cksetzen</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveConfig(event) {
    event.preventDefault();
    
    const form = document.getElementById('config-form');
    const formData = new FormData(form);
    
    const config = {};
    for (let [key, value] of formData.entries()) {
        // Convert to appropriate type
        if (key.includes('password') || key.includes('sensor') || key.includes('ip') || key === 'log_level') {
            config[key] = value;
        } else if (key === 'enable_tibber_optimization') {
            config[key] = true;
        } else if (value.includes('.')) {
            config[key] = parseFloat(value);
        } else {
            config[key] = parseInt(value);
        }
    }
    
    // Handle checkbox if not checked
    if (!formData.has('enable_tibber_optimization')) {
        config.enable_tibber_optimization = false;
    }
    
    showLoading('Speichere Konfiguration...');

    fetch(apiUrl('api/config'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.status === 'ok') {
            showNotification('success', 'Konfiguration gespeichert! Neustart erforderlich.');
        } else {
            showNotification('error', 'Fehler beim Speichern: ' + data.message);
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('error', 'Fehler beim Speichern der Konfiguration');
        console.error(error);
    });
}
</script>
{% endblock %}
